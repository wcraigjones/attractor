generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RunType {
  planning
  implementation
  task
}

enum EnvironmentKind {
  KUBERNETES_JOB
}

enum RunStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
  TIMEOUT
}

enum ReviewDecision {
  APPROVE
  REQUEST_CHANGES
  REJECT
  EXCEPTION
}

enum AttractorScope {
  PROJECT
  GLOBAL
}

enum RunQuestionStatus {
  PENDING
  ANSWERED
  TIMEOUT
}

enum TaskTemplateEnvironmentMode {
  PROJECT_DEFAULT
  NAMED
}

enum TaskTemplateLaunchMode {
  MANUAL
  SCHEDULE
  EVENT
  REPLAY
}

enum AgentScope {
  GLOBAL
  PROJECT
}

enum AgentMessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum AgentActionStatus {
  PENDING
  EXECUTED
  REJECTED
  FAILED
}

enum AgentActionRisk {
  LOW
  HIGH
}

model Project {
  id                   String         @id @default(cuid())
  name                 String
  namespace            String         @unique
  githubInstallationId String?
  repoFullName         String?
  defaultBranch        String?
  defaultEnvironmentId String?
  redeployAttractorId  String?
  redeploySourceBranch String?
  redeployTargetBranch String?
  redeployEnvironmentId String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  secrets              ProjectSecret[]
  attractors           AttractorDef[]
  runs                 Run[]
  taskTemplates        TaskTemplate[]
  taskTemplateEvents   TaskTemplateEventLedger[]
  agentSessions        AgentSession[]
  githubIssues         GitHubIssue[]
  githubPullRequests   GitHubPullRequest[]
  githubSyncState      GitHubSyncState?
  defaultEnvironment   Environment?   @relation("ProjectDefaultEnvironment", fields: [defaultEnvironmentId], references: [id], onDelete: SetNull)
  redeployAttractor    AttractorDef?  @relation("ProjectRedeployAttractor", fields: [redeployAttractorId], references: [id], onDelete: SetNull)
  redeployEnvironment  Environment?   @relation("ProjectRedeployEnvironment", fields: [redeployEnvironmentId], references: [id], onDelete: SetNull)

  @@index([defaultEnvironmentId])
  @@index([redeployAttractorId])
  @@index([redeployEnvironmentId])
}

model GlobalSecret {
  id            String   @id @default(cuid())
  name          String   @unique
  provider      String
  k8sSecretName String
  keyMappings   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GlobalAttractor {
  id             String   @id @default(cuid())
  name           String   @unique
  repoPath       String?
  contentPath    String?
  contentVersion Int      @default(0)
  defaultRunType RunType
  modelConfig    Json?
  description    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  versions       GlobalAttractorVersion[]
}

model GlobalTaskTemplate {
  id              String                      @id @default(cuid())
  name            String                      @unique
  attractorName   String
  runType         RunType
  sourceBranch    String?
  targetBranch    String?
  environmentMode TaskTemplateEnvironmentMode @default(PROJECT_DEFAULT)
  environmentName String?
  scheduleEnabled Boolean                     @default(false)
  scheduleCron    String?
  scheduleTimezone String?
  triggersJson    Json?
  description     String?
  active          Boolean                     @default(true)
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
}

model ProjectSecret {
  id            String   @id @default(cuid())
  projectId     String
  name          String
  provider      String
  k8sSecretName String
  keyMappings   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
}

model AttractorDef {
  id             String   @id @default(cuid())
  projectId      String
  scope          AttractorScope @default(PROJECT)
  name           String
  repoPath       String?
  contentPath    String?
  contentVersion Int      @default(0)
  defaultRunType RunType
  modelConfig    Json?
  description    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  redeployForProjects Project[] @relation("ProjectRedeployAttractor")
  runs           Run[]
  versions       AttractorDefVersion[]

  @@unique([projectId, name, scope])
}

model GlobalAttractorVersion {
  id               String         @id @default(cuid())
  globalAttractorId String
  version          Int
  contentPath      String
  contentSha256    String
  sizeBytes        Int
  createdAt        DateTime       @default(now())
  globalAttractor  GlobalAttractor @relation(fields: [globalAttractorId], references: [id], onDelete: Cascade)

  @@unique([globalAttractorId, version])
  @@index([globalAttractorId, createdAt])
}

model AttractorDefVersion {
  id             String      @id @default(cuid())
  attractorDefId String
  version        Int
  contentPath    String
  contentSha256  String
  sizeBytes      Int
  createdAt      DateTime    @default(now())
  attractorDef   AttractorDef @relation(fields: [attractorDefId], references: [id], onDelete: Cascade)

  @@unique([attractorDefId, version])
  @@index([attractorDefId, createdAt])
}

model Run {
  id            String      @id @default(cuid())
  projectId     String
  attractorDefId String
  taskTemplateId String?
  taskTemplateLaunchMode TaskTemplateLaunchMode?
  attractorContentPath String?
  attractorContentVersion Int?
  attractorContentSha256 String?
  githubIssueId String?
  githubPullRequestId String?
  environmentId String?
  runType       RunType
  sourceBranch  String
  targetBranch  String
  status        RunStatus   @default(QUEUED)
  specBundleId  String?
  environmentSnapshot Json?
  prUrl         String?
  error         String?
  createdAt     DateTime    @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  attractorDef  AttractorDef @relation(fields: [attractorDefId], references: [id], onDelete: Cascade)
  taskTemplate  TaskTemplate? @relation(fields: [taskTemplateId], references: [id], onDelete: SetNull)
  githubIssue   GitHubIssue? @relation(fields: [githubIssueId], references: [id], onDelete: SetNull)
  githubPullRequest GitHubPullRequest? @relation(fields: [githubPullRequestId], references: [id], onDelete: SetNull)
  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: SetNull)
  events        RunEvent[]
  artifacts     Artifact[]
  review        RunReview?
  checkpoint    RunCheckpoint?
  nodeOutcomes  RunNodeOutcome[]
  questions     RunQuestion[]
  taskTemplateEvents TaskTemplateEventLedger[]
  producedSpecBundle SpecBundle? @relation("ProducedSpecBundle")
  referencedSpecBundle SpecBundle? @relation("ReferencedSpecBundle", fields: [specBundleId], references: [id], onDelete: SetNull)

  @@index([projectId, status])
  @@index([projectId, targetBranch, runType, status])
  @@index([githubIssueId])
  @@index([githubPullRequestId])
  @@index([environmentId])
  @@index([taskTemplateId])
}

model RunReview {
  id               String         @id @default(cuid())
  runId            String         @unique
  reviewer         String
  decision         ReviewDecision
  checklistJson    Json
  summary          String?
  criticalFindings String?
  artifactFindings String?
  attestation      String?
  reviewedHeadSha  String?
  summarySnapshotJson Json?
  criticalSectionsSnapshotJson Json?
  artifactFocusSnapshotJson Json?
  githubCheckRunId String?
  githubSummaryCommentId String?
  githubWritebackStatus String?
  githubWritebackAt DateTime?
  reviewedAt       DateTime       @default(now())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  run              Run            @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([reviewedAt])
}

model GitHubIssue {
  id          String    @id @default(cuid())
  projectId   String
  issueNumber Int
  state       String
  title       String
  body        String?
  author      String?
  labelsJson  Json?
  assigneesJson Json?
  url         String
  openedAt    DateTime
  closedAt    DateTime?
  updatedAt   DateTime
  syncedAt    DateTime  @default(now())
  createdAt   DateTime  @default(now())
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  runs        Run[]
  pullRequests GitHubPullRequest[]

  @@unique([projectId, issueNumber])
  @@index([projectId, state, syncedAt])
  @@index([projectId, syncedAt])
}

model GitHubPullRequest {
  id            String    @id @default(cuid())
  projectId      String
  prNumber       Int
  state          String
  title          String
  body           String?
  url            String
  headRefName    String
  headSha        String
  baseRefName    String
  mergedAt       DateTime?
  openedAt       DateTime
  closedAt       DateTime?
  updatedAt      DateTime
  syncedAt       DateTime  @default(now())
  linkedIssueId  String?
  project        Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  linkedIssue    GitHubIssue? @relation(fields: [linkedIssueId], references: [id], onDelete: SetNull)
  runs           Run[]

  @@unique([projectId, prNumber])
  @@index([projectId, state, syncedAt])
  @@index([projectId, headSha])
  @@index([linkedIssueId])
}

model GitHubSyncState {
  projectId       String   @id
  issuesCursor    String?
  pullsCursor     String?
  lastIssueSyncAt DateTime?
  lastPullSyncAt  DateTime?
  lastError       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Environment {
  id                 String          @id @default(cuid())
  name               String          @unique
  kind               EnvironmentKind @default(KUBERNETES_JOB)
  runnerImage        String
  setupScript        String?
  serviceAccountName String?
  resourcesJson      Json?
  active             Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  defaultForProjects Project[]       @relation("ProjectDefaultEnvironment")
  redeployForProjects Project[]      @relation("ProjectRedeployEnvironment")
  runs               Run[]
}

model AgentSession {
  id            String      @id @default(cuid())
  scope         AgentScope
  projectId     String?
  title         String
  createdByEmail String?
  archivedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  project       Project?    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages      AgentMessage[]
  actions       AgentAction[]

  @@index([scope, projectId, updatedAt])
  @@index([projectId, createdAt])
}

model AgentMessage {
  id            String           @id @default(cuid())
  sessionId     String
  role          AgentMessageRole
  content       String
  partsJson     Json?
  tokenUsageJson Json?
  createdAt     DateTime         @default(now())
  session       AgentSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  actions       AgentAction[]

  @@index([sessionId, createdAt])
}

model AgentAction {
  id              String            @id @default(cuid())
  sessionId       String
  messageId       String?
  type            String
  risk            AgentActionRisk
  status          AgentActionStatus @default(PENDING)
  summary         String
  argsJson        Json
  resultJson      Json?
  error           String?
  requestedByEmail String?
  resolvedByEmail String?
  requestedAt     DateTime          @default(now())
  resolvedAt      DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  session         AgentSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  message         AgentMessage?     @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([sessionId, status, requestedAt])
  @@index([messageId])
}

model SpecBundle {
  id           String   @id @default(cuid())
  runId        String   @unique
  schemaVersion String
  manifestPath String
  createdAt    DateTime @default(now())
  run          Run      @relation("ProducedSpecBundle", fields: [runId], references: [id], onDelete: Cascade)
  referencedBy Run[]    @relation("ReferencedSpecBundle")
}

model Artifact {
  id        String   @id @default(cuid())
  runId      String
  key       String
  path      String
  contentType String?
  sizeBytes Int?
  createdAt DateTime @default(now())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@unique([runId, key])
}

model RunEvent {
  id      String   @id @default(cuid())
  runId    String
  ts      DateTime @default(now())
  type    String
  payload Json
  run     Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, ts])
}

model RunCheckpoint {
  id            String   @id @default(cuid())
  runId         String   @unique
  currentNodeId String
  contextJson   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  run           Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model RunNodeOutcome {
  id        String   @id @default(cuid())
  runId     String
  nodeId    String
  status    String
  attempt   Int
  payload   Json
  createdAt DateTime @default(now())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, nodeId])
}

model RunQuestion {
  id         String            @id @default(cuid())
  runId      String
  nodeId     String
  prompt     String
  options    Json?
  answer     Json?
  status     RunQuestionStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  answeredAt DateTime?
  run        Run               @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, status, createdAt])
}

model TaskTemplate {
  id               String                      @id @default(cuid())
  projectId        String
  scope            AttractorScope              @default(PROJECT)
  name             String
  attractorName    String
  runType          RunType
  sourceBranch     String?
  targetBranch     String?
  environmentMode  TaskTemplateEnvironmentMode @default(PROJECT_DEFAULT)
  environmentName  String?
  scheduleEnabled  Boolean                     @default(false)
  scheduleCron     String?
  scheduleTimezone String?
  scheduleNextRunAt DateTime?
  scheduleLastRunAt DateTime?
  scheduleLastError String?
  triggersJson     Json?
  description      String?
  active           Boolean                     @default(true)
  createdAt        DateTime                    @default(now())
  updatedAt        DateTime                    @updatedAt
  project          Project                     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  runs             Run[]
  eventLedger      TaskTemplateEventLedger[]

  @@unique([projectId, name, scope])
  @@index([projectId, active, scheduleEnabled, scheduleNextRunAt])
  @@index([projectId, scope])
}

model TaskTemplateEventLedger {
  id             String       @id @default(cuid())
  projectId      String
  taskTemplateId String
  runId          String?
  eventName      String
  eventAction    String?
  dedupeKey      String
  deliveryId     String?
  entityType     String?
  entityNumber   Int?
  matchedRuleIds Json?
  payload        Json
  status         String
  reason         String?
  replayedAt     DateTime?
  createdAt      DateTime     @default(now())
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskTemplate   TaskTemplate @relation(fields: [taskTemplateId], references: [id], onDelete: Cascade)
  run            Run?         @relation(fields: [runId], references: [id], onDelete: SetNull)

  @@unique([taskTemplateId, dedupeKey])
  @@index([projectId, createdAt])
  @@index([taskTemplateId, createdAt])
  @@index([runId])
}
