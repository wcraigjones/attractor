generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RunType {
  planning
  implementation
}

enum EnvironmentKind {
  KUBERNETES_JOB
}

enum RunStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
  TIMEOUT
}

enum AttractorScope {
  PROJECT
  GLOBAL
}

model Project {
  id                   String         @id @default(cuid())
  name                 String
  namespace            String         @unique
  githubInstallationId String?
  repoFullName         String?
  defaultBranch        String?
  defaultEnvironmentId String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  secrets              ProjectSecret[]
  attractors           AttractorDef[]
  runs                 Run[]
  defaultEnvironment   Environment?   @relation("ProjectDefaultEnvironment", fields: [defaultEnvironmentId], references: [id], onDelete: SetNull)

  @@index([defaultEnvironmentId])
}

model GlobalSecret {
  id            String   @id @default(cuid())
  name          String   @unique
  provider      String
  k8sSecretName String
  keyMappings   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GlobalAttractor {
  id             String   @id @default(cuid())
  name           String   @unique
  repoPath       String
  defaultRunType RunType
  description    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model ProjectSecret {
  id            String   @id @default(cuid())
  projectId     String
  name          String
  provider      String
  k8sSecretName String
  keyMappings   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
}

model AttractorDef {
  id             String   @id @default(cuid())
  projectId      String
  scope          AttractorScope @default(PROJECT)
  name           String
  repoPath       String
  defaultRunType RunType
  description    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  runs           Run[]

  @@unique([projectId, name, scope])
}

model Run {
  id            String      @id @default(cuid())
  projectId     String
  attractorDefId String
  environmentId String?
  runType       RunType
  sourceBranch  String
  targetBranch  String
  status        RunStatus   @default(QUEUED)
  specBundleId  String?
  environmentSnapshot Json?
  prUrl         String?
  error         String?
  createdAt     DateTime    @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  attractorDef  AttractorDef @relation(fields: [attractorDefId], references: [id], onDelete: Cascade)
  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: SetNull)
  events        RunEvent[]
  artifacts     Artifact[]
  producedSpecBundle SpecBundle? @relation("ProducedSpecBundle")
  referencedSpecBundle SpecBundle? @relation("ReferencedSpecBundle", fields: [specBundleId], references: [id], onDelete: SetNull)

  @@index([projectId, status])
  @@index([projectId, targetBranch, runType, status])
  @@index([environmentId])
}

model Environment {
  id                 String          @id @default(cuid())
  name               String          @unique
  kind               EnvironmentKind @default(KUBERNETES_JOB)
  runnerImage        String
  serviceAccountName String?
  resourcesJson      Json?
  active             Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  defaultForProjects Project[]       @relation("ProjectDefaultEnvironment")
  runs               Run[]
}

model SpecBundle {
  id           String   @id @default(cuid())
  runId        String   @unique
  schemaVersion String
  manifestPath String
  createdAt    DateTime @default(now())
  run          Run      @relation("ProducedSpecBundle", fields: [runId], references: [id], onDelete: Cascade)
  referencedBy Run[]    @relation("ReferencedSpecBundle")
}

model Artifact {
  id        String   @id @default(cuid())
  runId      String
  key       String
  path      String
  contentType String?
  sizeBytes Int?
  createdAt DateTime @default(now())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@unique([runId, key])
}

model RunEvent {
  id      String   @id @default(cuid())
  runId    String
  ts      DateTime @default(now())
  type    String
  payload Json
  run     Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, ts])
}
