generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RunType {
  planning
  implementation
  task
}

enum EnvironmentKind {
  KUBERNETES_JOB
}

enum RunStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
  CANCELED
  TIMEOUT
}

enum ReviewDecision {
  APPROVE
  REQUEST_CHANGES
  REJECT
  EXCEPTION
}

enum AttractorScope {
  PROJECT
  GLOBAL
}

enum RunQuestionStatus {
  PENDING
  ANSWERED
  TIMEOUT
}

model Project {
  id                   String         @id @default(cuid())
  name                 String
  namespace            String         @unique
  githubInstallationId String?
  repoFullName         String?
  defaultBranch        String?
  defaultEnvironmentId String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  secrets              ProjectSecret[]
  attractors           AttractorDef[]
  runs                 Run[]
  defaultEnvironment   Environment?   @relation("ProjectDefaultEnvironment", fields: [defaultEnvironmentId], references: [id], onDelete: SetNull)

  @@index([defaultEnvironmentId])
}

model GlobalSecret {
  id            String   @id @default(cuid())
  name          String   @unique
  provider      String
  k8sSecretName String
  keyMappings   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model GlobalAttractor {
  id             String   @id @default(cuid())
  name           String   @unique
  repoPath       String?
  contentPath    String?
  contentVersion Int      @default(0)
  defaultRunType RunType
  description    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  versions       GlobalAttractorVersion[]
}

model ProjectSecret {
  id            String   @id @default(cuid())
  projectId     String
  name          String
  provider      String
  k8sSecretName String
  keyMappings   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name])
}

model AttractorDef {
  id             String   @id @default(cuid())
  projectId      String
  scope          AttractorScope @default(PROJECT)
  name           String
  repoPath       String?
  contentPath    String?
  contentVersion Int      @default(0)
  defaultRunType RunType
  description    String?
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  runs           Run[]
  versions       AttractorDefVersion[]

  @@unique([projectId, name, scope])
}

model GlobalAttractorVersion {
  id               String         @id @default(cuid())
  globalAttractorId String
  version          Int
  contentPath      String
  contentSha256    String
  sizeBytes        Int
  createdAt        DateTime       @default(now())
  globalAttractor  GlobalAttractor @relation(fields: [globalAttractorId], references: [id], onDelete: Cascade)

  @@unique([globalAttractorId, version])
  @@index([globalAttractorId, createdAt])
}

model AttractorDefVersion {
  id             String      @id @default(cuid())
  attractorDefId String
  version        Int
  contentPath    String
  contentSha256  String
  sizeBytes      Int
  createdAt      DateTime    @default(now())
  attractorDef   AttractorDef @relation(fields: [attractorDefId], references: [id], onDelete: Cascade)

  @@unique([attractorDefId, version])
  @@index([attractorDefId, createdAt])
}

model Run {
  id            String      @id @default(cuid())
  projectId     String
  attractorDefId String
  environmentId String?
  runType       RunType
  sourceBranch  String
  targetBranch  String
  status        RunStatus   @default(QUEUED)
  specBundleId  String?
  environmentSnapshot Json?
  prUrl         String?
  error         String?
  createdAt     DateTime    @default(now())
  startedAt     DateTime?
  finishedAt    DateTime?
  project       Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  attractorDef  AttractorDef @relation(fields: [attractorDefId], references: [id], onDelete: Cascade)
  environment   Environment? @relation(fields: [environmentId], references: [id], onDelete: SetNull)
  events        RunEvent[]
  artifacts     Artifact[]
  review        RunReview?
  checkpoint    RunCheckpoint?
  nodeOutcomes  RunNodeOutcome[]
  questions     RunQuestion[]
  producedSpecBundle SpecBundle? @relation("ProducedSpecBundle")
  referencedSpecBundle SpecBundle? @relation("ReferencedSpecBundle", fields: [specBundleId], references: [id], onDelete: SetNull)

  @@index([projectId, status])
  @@index([projectId, targetBranch, runType, status])
  @@index([environmentId])
}

model RunReview {
  id               String         @id @default(cuid())
  runId            String         @unique
  reviewer         String
  decision         ReviewDecision
  checklistJson    Json
  summary          String?
  criticalFindings String?
  artifactFindings String?
  attestation      String?
  reviewedAt       DateTime       @default(now())
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  run              Run            @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([reviewedAt])
}

model Environment {
  id                 String          @id @default(cuid())
  name               String          @unique
  kind               EnvironmentKind @default(KUBERNETES_JOB)
  runnerImage        String
  serviceAccountName String?
  resourcesJson      Json?
  active             Boolean         @default(true)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  defaultForProjects Project[]       @relation("ProjectDefaultEnvironment")
  runs               Run[]
}

model SpecBundle {
  id           String   @id @default(cuid())
  runId        String   @unique
  schemaVersion String
  manifestPath String
  createdAt    DateTime @default(now())
  run          Run      @relation("ProducedSpecBundle", fields: [runId], references: [id], onDelete: Cascade)
  referencedBy Run[]    @relation("ReferencedSpecBundle")
}

model Artifact {
  id        String   @id @default(cuid())
  runId      String
  key       String
  path      String
  contentType String?
  sizeBytes Int?
  createdAt DateTime @default(now())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@unique([runId, key])
}

model RunEvent {
  id      String   @id @default(cuid())
  runId    String
  ts      DateTime @default(now())
  type    String
  payload Json
  run     Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, ts])
}

model RunCheckpoint {
  id            String   @id @default(cuid())
  runId         String   @unique
  currentNodeId String
  contextJson   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  run           Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
}

model RunNodeOutcome {
  id        String   @id @default(cuid())
  runId     String
  nodeId    String
  status    String
  attempt   Int
  payload   Json
  createdAt DateTime @default(now())
  run       Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, nodeId])
}

model RunQuestion {
  id         String            @id @default(cuid())
  runId      String
  nodeId     String
  prompt     String
  options    Json?
  answer     Json?
  status     RunQuestionStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  answeredAt DateTime?
  run        Run               @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId, status, createdAt])
}
